name: Build iOS App

on:
  workflow_dispatch:
  push:
    tags:
      - "ios_v*"

jobs:
  build-ios:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      # ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          ref: main

      # è®¾ç½®Flutter
      - name: Flutter action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x"
          cache: true

      # æ›´æ–°Flutterçš„packages
      - name: Restore packages
        run: |
          cd simple_live_app
          flutter pub get

      # æ‰“åŒ…iOS
      - name: Build IPA
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign

      # åˆ›å»ºæœªç­¾åipaï¼ˆå®Œå…¨ç§»é™¤ç­¾åä»¥å…¼å®¹ LiveContainerï¼‰
      - name: Create IPA
        run: |
          cd simple_live_app
          APP_PATH="build/ios/iphoneos/Runner.app"
          
          # ä½¿ç”¨ codesign ç§»é™¤ä¸»äºŒè¿›åˆ¶æ–‡ä»¶çš„ç­¾å
          codesign --remove-signature "$APP_PATH/Runner" || true
          
          # ç§»é™¤æ‰€æœ‰ Framework ä¸­çš„ç­¾å
          find "$APP_PATH/Frameworks" -name "*.framework" -type d | while read framework; do
            framework_name=$(basename "$framework" .framework)
            if [ -f "$framework/$framework_name" ]; then
              codesign --remove-signature "$framework/$framework_name" || true
            fi
          done
          
          # ç§»é™¤æ‰€æœ‰ dylib çš„ç­¾å
          find "$APP_PATH" -name "*.dylib" -type f -exec codesign --remove-signature {} \; 2>/dev/null || true
          
          # ç§»é™¤æ‰€æœ‰ç­¾åç›¸å…³ç›®å½•å’Œæ–‡ä»¶
          rm -rf "$APP_PATH/_CodeSignature"
          rm -f "$APP_PATH/embedded.mobileprovision"
          find "$APP_PATH/Frameworks" -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$APP_PATH/Frameworks" -name "embedded.mobileprovision" -delete 2>/dev/null || true
          
          # åˆ›å»º Payload ç›®å½•å¹¶å¤åˆ¶ app
          mkdir -p build/ios/iphoneos/Payload
          cp -R "$APP_PATH" build/ios/iphoneos/Payload/Runner.app
          
          # æ‰“åŒ…ä¸º IPA
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload
          cd ../../..

      # ä¸Šä¼ IPAè‡³Artifacts
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # å®Œæˆ
      - run: echo "ğŸ iOS build job's status is ${{ job.status }}."
